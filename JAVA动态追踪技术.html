<!-- build time:Sat Sep 21 2019 18:23:55 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>JAVA动态追踪技术 | 晓风残月的博客</title><meta name="keywords" content="java,动态追踪技术,BTrace, java,多线程,高并发,架构"><meta name="description" content="JAVA动态追踪技术, 个人技术的一些积累"><link rel="alternate" href="atom.xml" title="晓风残月的博客"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css"><link rel="shortcut icon" type="image/x-icon" href="/images/website/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.9.2/css/style.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a475efbbf07ecf405a82aa9bd596d186";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><header class="l_header pure"><div id="loading-bar-wrapper"><div id="loading-bar" class="pure"></div></div><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="index.html">晓风残月的博客</a><div class="menu navgation"><ul class="h-list"><li><a class="nav flat-box" href="index.html" id="index.html"><i class="fas fa-newspaper fa-fw"></i>&nbsp;博文</a></li><li><a class="nav flat-box" href="categories/" rel="nofollow" id="categories"><i class="fas fa-grip-horizontal fa-fw"></i>&nbsp;分类</a></li><li><a class="nav flat-box" href="tags/" rel="nofollow" id="tags"><i class="fas fa-tags fa-fw"></i>&nbsp;标签</a></li><li><a class="nav flat-box" href="archives/" rel="nofollow" id="archives"><i class="fas fa-archive fa-fw"></i>&nbsp;归档</a></li></ul></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="搜索"> <i class="icon fas fa-search fa-fw"></i></form></div><ul class="switcher h-list"><li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li><li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo flat-box"></a><ul class="switcher h-list"><li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" href="javascript:void(0)"></a></li><li class="s-toc"><a class="flat-btn fas fa-list fa-fw" href="javascript:void(0)"></a></li></ul></div></div></header><aside class="menu-phone"><header><nav class="menu navgation"><ul><li><a class="nav flat-box" href="index.html" id="index.html"><i class="fas fa-clock fa-fw"></i>&nbsp;近期文章</a></li><li><a class="nav flat-box" href="archives/" rel="nofollow" id="archives"><i class="fas fa-archive fa-fw"></i>&nbsp;文章归档</a></li><li><a class="nav flat-box" href="categories/" id="categories"><i class="fas fa-grip-horizontal fa-fw"></i>&nbsp;文章分类</a></li><li><a class="nav flat-box" href="/friends.html" rel="nofollow" id="friends.html"><i class="fas fa-link fa-fw"></i>&nbsp;我的友链</a></li><li><a class="nav flat-box" href="/about.html" rel="nofollow" id="about.html"><i class="fas fa-info-circle fa-fw"></i>&nbsp;关于小站</a></li></ul></nav></header></aside><script>setLoadingBarProgress(40)</script><div class="l_body nocover"><div class="body-wrapper"><div class="l_main"><article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><div class="meta" id="header-meta"><h1 class="title"><a href>JAVA动态追踪技术</a></h1><div class="new-meta-box"><div style="margin-top:10px"><span class="post-time"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> <span class="post-meta-item-text">字数统计：</span> <span class="post-count">4.7k字</span> </span></span><span class="post-time">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="far fa-clock"></i> <span class="post-meta-item-text">阅读时长 ≈</span> <span class="post-count">17分</span></span></span></div></div><div class="new-meta-box"><div class="new-meta-item author"><a href="http://www.baiyp.ren" rel="nofollow"><img src="/images/website/avatar.jpg"><p>晓风残月</p></a></div><div class="new-meta-item date"><a class="notlink"><i class="fas fa-calendar-alt" aria-hidden="true"></i><p>2019-09-15</p></a></div><div class="new-meta-item category"><a href rel="nofollow"><i class="fas fa-folder-open" aria-hidden="true"></i><p>架构&nbsp;/&nbsp;动态追踪</p></a></div><div class="new-meta-item browse busuanzi"><a class="notlink"><i class="fas fa-eye" aria-hidden="true"></i><p><span id="busuanzi_value_page_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></p></a></div></div><hr></div></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><h2 id="JAVA动态追踪技术"><a href="#JAVA动态追踪技术" class="headerlink" title="JAVA动态追踪技术"></a>JAVA动态追踪技术</h2><h3 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h3><p>在遥远的希艾斯星球爪哇国塞沃城中，两名年轻的程序员正在为一件事情苦恼，程序出问题了，一时看不出问题出在哪里，于是有了以下对话：</p><p>“Debug一下吧。”</p><p>“线上机器，没开Debug端口。”</p><p>“看日志，看看请求值和返回值分别是什么？”</p><p>“那段代码没打印日志。”</p><p>“改代码，加日志，重新发布一次。”</p><p>“怀疑是线程池的问题，重启会破坏现场。”</p><p>长达几十秒的沉默之后：“据说，排查问题的最高境界，就是只通过Review代码来发现问题。”</p><p>比几十秒长几十倍的沉默之后：“我轮询了那段代码一十七遍之后，终于得出一个结论。”</p><p>“结论是？”</p><p>“我还没到达只通过Review代码就能发现问题的至高境界。”</p><h3 id="从JSP说起"><a href="#从JSP说起" class="headerlink" title="从JSP说起"></a>从JSP说起</h3><p>​ 对于大多数Java程序员来说，早期的时候，都会接触到一个叫做JSP（Java Server Pages）的技术。虽然这种技术，在前后端代码分离、前后端逻辑分离、前后端组织架构分离的今天来看，已经过时了，但是其中还是有一些有意思的东西，值得拿出来说一说。</p><p>当时刚刚处于Java入门时期的我们，大多数精力似乎都放在了JSP的页面展示效果上了：</p><p>“这个表格显示的行数不对。”</p><p>“原来是for循环写的有问题，改一下，刷新页面再试一遍。”</p><p>“嗯，好了，表格显示没问题了，但是，登录人的姓名没取到啊，是不是Session获取有问题？”</p><p>“有可能，我再改一下，一会儿再刷新试试。”</p><p>……</p><p>​ 在一遍一遍修改代码刷新浏览器页面重试的时候，我们自己也许并没有注意到一件很酷的事情：我们修改完代码，居然只是简单地刷新一遍浏览器页面，修改就生效了，整个过程并没有重启JVM。按照我们的常识，Java程序一般都是在启动时加载类文件，如果都像JSP这样修改完代码，不用重启就生效的话，那文章开头的问题就可以解决了啊：Java文件中加一段日志打印的代码，不重启就生效，既不破坏现场，又可以定位问题。忍不住试一试：修改、编译、替换class文件。额，不行，新改的代码并没有生效。那为什么偏偏JSP可以呢？让我们先来看看JSP的运行原理。</p><p>当我们打开浏览器，请求访问一个JSP文件的时候，整个过程是这样的：</p><p><img src="../images/dynamictracing/jsp01.png" alt></p><p>​ JSP文件修改过后，之所以能及时生效，是因为Web容器（Tomcat）会检查请求的JSP文件是否被更改过。如果发生过更改，那么就将JSP文件重新解析翻译成一个新的Sevlet类，并加载到JVM中。之后的请求，都会由这个新的Servlet来处理。这里有个问题，根据Java的类加载机制，在同一个ClassLoader中，类是不允许重复的。为了绕开这个限制，Web容器每次都会创建一个新的ClassLoader实例，来加载新编译的Servlet类。之后的请求都会由这个新的Servlet来处理，这样就实现了新旧JSP的切换。</p><p>​ HTTP服务是无状态的，所以JSP的场景基本上都是一次性消费。这种通过创建新的ClassLoader来“替换”class的做法行得通，但是对于其他应用，比如Spring框架，即便这样做了，对象多数是单例。对于内存中已经创建好的对象，我们无法通过这种创建新的ClassLoader实例的方法来修改对象行为。</p><p>我就是想不重启应用加个日志打印，就这么难吗？</p><h3 id="Java对象行为"><a href="#Java对象行为" class="headerlink" title="Java对象行为"></a>Java对象行为</h3><p>​ 既然JSP的办法行不通，那我们来看看还有没有其他的办法。仔细想想，我们会发现，文章开头的问题本质上是动态改变内存中已存在对象的行为问题。所以，我们得先弄清楚JVM中和对象行为有关的地方在哪里，有没有更改的可能性。</p><p>我们都知道，对象使用两种东西来描述事物：行为和属性。举个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">speak</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(<span class="keyword">int</span> age, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​ 上面Person类中age和name是属性，speak是行为。对象是类的实例，每个对象的属性都属于对象本身，但是每个对象的行为却是公共的。举个例子，比如我们现在基于Person类创建了两个对象，personA和personB：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Person personA = <span class="keyword">new</span> Person(<span class="number">43</span>, <span class="string">"lixunhuan"</span>);</span><br><span class="line"></span><br><span class="line">personA.speak(<span class="string">"我是李寻欢"</span>);</span><br><span class="line"></span><br><span class="line">Person personB = <span class="keyword">new</span> Person(<span class="number">23</span>, <span class="string">"afei"</span>);</span><br><span class="line"></span><br><span class="line">personB.speak(<span class="string">"我是阿飞"</span>);</span><br></pre></td></tr></table></figure><p>personA和personB有各自的姓名和年龄，但是有共同的行为：speak。想象一下，如果我们是Java语言的设计者，我们会怎么存储对象的行为和属性呢？</p><p>“很简单，属性跟着对象走，每个对象都存一份。行为是公共的东西，抽离出来，单独放到一个地方。”</p><p>“咦？抽离出公共的部分，跟代码复用好像啊。”</p><p>“大道至简，很多东西本来都是殊途同归。”</p><p>也就是说，第一步我们首先得找到存储对象行为的这个公共的地方。一番搜索之后，我们发现这样一段描述：</p><blockquote><p>Method area is created on virtual machine startup, shared among all Java virtual machine threads and it is logically part of heap area. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors.</p></blockquote><p>Java的对象行为（方法、函数）是存储在方法区的。</p><p>“方法区中的数据从哪来？”</p><p>“方法区中的数据是类加载时从class文件中提取出来的。”</p><p>“class文件从哪来？”</p><p>“从Java或者其他符合JVM规范的源代码中编译而来。”</p><p>“源代码从哪来？”</p><p>“废话，当然是手写！”</p><p>“倒着推，手写没问题，编译没问题，至于加载……有没有办法加载一个已经加载过的类呢？如果有的话，我们就能修改字节码中目标方法所在的区域，然后重新加载这个类，这样方法区中的对象行为（方法）就被改变了，而且不改变对象的属性，也不影响已经存在对象的状态，那么就可以搞定这个问题了。可是，这岂不是违背了JVM的类加载原理？毕竟我们不想改变ClassLoader。”</p><p>“少年，可以去看看<code>java.lang.instrument.Instrumentation</code>。”</p><h3 id="java-lang-instrument-Instrumentation"><a href="#java-lang-instrument-Instrumentation" class="headerlink" title="java.lang.instrument.Instrumentation"></a>java.lang.instrument.Instrumentation</h3><p>看完文档之后，我们发现这么两个接口：<strong>redefineClasses</strong>和<strong>retransformClasses</strong>。一个是重新定义class，一个是修改class。这两个大同小异，看redefineClasses的说明：</p><blockquote><p>This method is used to replace the definition of a class without reference to the existing class file bytes, as one might do when recompiling from source for fix-and-continue debugging. Where the existing class file bytes are to be transformed (for example in bytecode instrumentation) retransformClasses should be used.</p></blockquote><p>都是替换已经存在的class文件，<strong>redefineClasses</strong>是自己提供字节码文件替换掉已存在的class文件，<strong>retransformClasses</strong>是在已存在的字节码文件上修改后再替换之。</p><p>当然，运行时直接替换类很不安全。比如新的class文件引用了一个不存在的类，或者把某个类的一个field给删除了等等，这些情况都会引发异常。所以如文档中所言，instrument存在诸多的限制：</p><blockquote><p>The redefinition may change method bodies, the constant pool and attributes. The redefinition must not add, remove or rename fields or methods, change the signatures of methods, or change inheritance. These restrictions maybe be lifted in future versions. The class file bytes are not checked, verified and installed until after the transformations have been applied, if the resultant bytes are in error this method will throw an exception.</p></blockquote><p>我们能做的基本上也就是简单修改方法内的一些行为，这对于我们开头的问题，打印一段日志来说，已经足够了。当然，我们除了通过retransform来打印日志，还能做很多其他非常有用的事情，这个下文会进行介绍。</p><p>那怎么得到我们需要的class文件呢？一个最简单的方法，是把修改后的Java文件重新编译一遍得到class文件，然后调用redefineClasses替换。但是对于没有（或者拿不到，或者不方便修改）源码的文件我们应该怎么办呢？其实对于JVM来说，不管是Java也好，Scala也好，任何一种符合JVM规范的语言的源代码，都可以编译成class文件。JVM的操作对象是class文件，而不是源码。所以，从这种意义上来讲，我们可以说“JVM跟语言无关”。既然如此，不管有没有源码，其实我们只需要修改class文件就行了。</p><h3 id="直接操作字节码"><a href="#直接操作字节码" class="headerlink" title="直接操作字节码"></a>直接操作字节码</h3><p>​ Java是软件开发人员能读懂的语言，class字节码是JVM能读懂的语言，class字节码最终会被JVM解释成机器能读懂的语言。无论哪种语言，都是人创造的。所以，理论上（实际上也确实如此）人能读懂上述任何一种语言，既然能读懂，自然能修改。只要我们愿意，我们完全可以跳过Java编译器，直接写字节码文件，只不过这并不符合时代的发展罢了，毕竟高级语言设计之始就是为我们人类所服务，其开发效率也比机器语言高很多。</p><p>​ 对于人类来说，字节码文件的可读性远远没有Java代码高。尽管如此，还是有一些杰出的程序员们创造出了可以用来直接编辑字节码的框架，提供接口可以让我们方便地操作字节码文件，进行注入修改类的方法，动态创造一个新的类等等操作。其中最著名的框架应该就是ASM了，cglib、Spring等框架中对于字节码的操作就建立在ASM之上。</p><p>​ 我们都知道，Spring的AOP是基于动态代理实现的，Spring会在运行时动态创建代理类，代理类中引用被代理类，在被代理的方法执行前后进行一些神秘的操作。那么，Spring是怎么在运行时创建代理类的呢？动态代理的美妙之处，就在于我们不必手动为每个需要被代理的类写代理类代码，Spring在运行时会根据需要动态地创造出一个类。这里创造的过程并非通过字符串写Java文件，然后编译成class文件，然后加载。Spring会直接“创造”一个class文件，然后加载，创造class文件的工具，就是ASM了。</p><p>到这里，我们知道了用ASM框架直接操作class文件，在类中加一段打印日志的代码，然后retransform就可以了。</p><h3 id="BTrace"><a href="#BTrace" class="headerlink" title="BTrace"></a>BTrace</h3><p>截止到目前，我们都是停留在理论描述的层面。那么如何进行实现呢？先来看几个问题：</p><ul><li><p>在我们的工程中，谁来做这个寻找字节码，修改字节码，然后retransform的动作呢？我们并非先知，不可能知道未来有没有可能遇到文章开头的这种问题。考虑到性价比，我们也不可能在每个工程中都开发一段专门做这些修改字节码、重新加载字节码的代码。</p></li><li><p>如果JVM不在本地，在远程呢？</p></li><li><p>如果连ASM都不会用呢？能不能更通用一些，更“傻瓜”一些。</p></li></ul><p>幸运的是，因为有BTrace的存在，我们不必自己写一套这样的工具了。什么是BTrace呢？<a href="https://github.com/btraceio/btrace" rel="external nofollow noopener noreferrer" target="_blank">BTrace</a>已经开源，项目描述极其简短：</p><blockquote><p>A safe, dynamic tracing tool for the Java platform.</p></blockquote><p>BTrace是基于Java语言的一个安全的、可提供动态追踪服务的工具。BTrace基于ASM、Java Attach API、Instrument开发，为用户提供了很多注解。依靠这些注解，我们可以编写BTrace脚本（简单的Java代码）达到我们想要的效果，而不必深陷于ASM对字节码的操作中不可自拔。</p><p>看BTrace官方提供的一个简单例子：拦截所有java.io包中所有类中以read开头的方法，打印类名、方法名和参数名。当程序IO负载比较高的时候，就可以从输出的信息中看到是哪些类所引起，是不是很方便？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.btrace.samples;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.btrace.annotations.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.btrace.AnyType;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sun.btrace.BTraceUtils.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This sample demonstrates regular expression</span></span><br><span class="line"><span class="comment"> * probe matching and getting input arguments</span></span><br><span class="line"><span class="comment"> * as an array - so that any overload variant</span></span><br><span class="line"><span class="comment"> * can be traced in "one place". This example</span></span><br><span class="line"><span class="comment"> * traces any "readXX" method on any class in</span></span><br><span class="line"><span class="comment"> * java.io package. Probed class, method and arg</span></span><br><span class="line"><span class="comment"> * array is printed in the action.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@BTrace</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgArray</span> </span>&#123;</span><br><span class="line">    <span class="meta">@OnMethod</span>(</span><br><span class="line">        clazz=<span class="string">"/java\\.io\\..*/"</span>,</span><br><span class="line">        method=<span class="string">"/read.*/"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">anyRead</span><span class="params">(@ProbeClassName String pcn, @ProbeMethodName String pmn, AnyType[] args)</span> </span>&#123;</span><br><span class="line">        println(pcn);</span><br><span class="line">        println(pmn);</span><br><span class="line">        printArray(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来看另一个例子：每隔2秒打印截止到当前创建过的线程数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.btrace.samples;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.btrace.annotations.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sun.btrace.BTraceUtils.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.btrace.annotations.Export;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This sample creates a jvmstat counter and</span></span><br><span class="line"><span class="comment"> * increments it everytime Thread.start() is</span></span><br><span class="line"><span class="comment"> * called. This thread count may be accessed</span></span><br><span class="line"><span class="comment"> * from outside the process. The <span class="doctag">@Export</span> annotated</span></span><br><span class="line"><span class="comment"> * fields are mapped to jvmstat counters. The counter</span></span><br><span class="line"><span class="comment"> * name is "btrace." + &lt;className&gt; + "." + &lt;fieldName&gt;</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="meta">@BTrace</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadCounter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a jvmstat counter using @Export</span></span><br><span class="line">    <span class="meta">@Export</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMethod</span>(</span><br><span class="line">        clazz=<span class="string">"java.lang.Thread"</span>,</span><br><span class="line">        method=<span class="string">"start"</span></span><br><span class="line">    ) </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onnewThread</span><span class="params">(@Self Thread t)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// updating counter is easy. Just assign to</span></span><br><span class="line">        <span class="comment">// the static field!</span></span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnTimer</span>(<span class="number">2000</span>) </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ontimer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// we can access counter as "count" as well</span></span><br><span class="line">        <span class="comment">// as from jvmstat counter directly.</span></span><br><span class="line">        println(count);</span><br><span class="line">        <span class="comment">// or equivalently ...</span></span><br><span class="line">        println(Counters.perfLong(<span class="string">"btrace.com.sun.btrace.samples.ThreadCounter.count"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了上面的用法是不是有所启发？忍不住冒出来许多想法。比如查看HashMap什么时候会触发rehash，以及此时容器中有多少元素等等。</p><p>有了BTrace，文章开头的问题可以得到完美的解决。至于BTrace具体有哪些功能，脚本怎么写，这些Git上BTrace工程中有大量的说明和举例，网上介绍BTrace用法的文章更是恒河沙数，这里就不再赘述了。</p><p>我们明白了原理，又有好用的工具支持，剩下的就是发挥我们的创造力了，只需在合适的场景下合理地进行使用即可。</p><p>既然BTrace能解决上面我们提到的所有问题，那么BTrace的架构是怎样的呢？</p><p>BTrace主要有下面几个模块：</p><ol><li>BTrace脚本：利用BTrace定义的注解，我们可以很方便地根据需要进行脚本的开发。</li><li>Compiler：将BTrace脚本编译成BTrace class文件。</li><li>Client：将class文件发送到Agent。</li><li>Agent：基于Java的Attach API，Agent可以动态附着到一个运行的JVM上，然后开启一个BTrace Server，接收client发过来的BTrace脚本；解析脚本，然后根据脚本中的规则找到要修改的类；修改字节码后，调用Java Instrument的retransform接口，完成对对象行为的修改并使之生效。</li></ol><p>整个BTrace的架构大致如下：</p><p><img src="../images/dynamictracing/btrace01.png" alt></p><p>BTrace最终借Instrument实现class的替换。如上文所说，出于安全考虑，Instrument在使用上存在诸多的限制，BTrace也不例外。BTrace对JVM来说是“只读的”，因此BTrace脚本的限制如下：</p><ol><li>不允许创建对象</li><li>不允许创建数组</li><li>不允许抛异常</li><li>不允许catch异常</li><li>不允许随意调用其他对象或者类的方法，只允许调用com.sun.btrace.BTraceUtils中提供的静态方法（一些数据处理和信息输出工具）</li><li>不允许改变类的属性</li><li>不允许有成员变量和方法，只允许存在<strong>static public void</strong>方法</li><li>不允许有内部类、嵌套类</li><li>不允许有同步方法和同步块</li><li>不允许有循环</li><li>不允许随意继承其他类（当然，java.lang.Object除外）</li><li>不允许实现接口</li><li>不允许使用assert</li><li>不允许使用Class对象</li></ol><p>如此多的限制，其实可以理解。BTrace要做的是，虽然修改了字节码，但是除了输出需要的信息外，对整个程序的正常运行并没有影响。</p><h3 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h3><p>​ BTrace脚本在使用上有一定的学习成本，如果能把一些常用的功能封装起来，对外直接提供简单的命令即可操作的话，那就再好不过了。阿里的工程师们早已想到这一点，就在去年（2018年9月份），阿里巴巴开源了自己的Java诊断工具——<a href="https://github.com/alibaba/arthas" rel="external nofollow noopener noreferrer" target="_blank">Arthas</a>。Arthas提供简单的命令行操作，功能强大。究其背后的技术原理，和本文中提到的大致无二。Arthas的文档很全面，想详细了解的话可以戳<a href="https://alibaba.github.io/arthas/" rel="external nofollow noopener noreferrer" target="_blank">这里</a>。</p><p>本文旨在说明Java动态追踪技术的来龙去脉，掌握技术背后的原理之后，只要愿意，各位读者也可以开发出自己的“冰封王座”出来。</p><h3 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h3><p>现在，让我们试着站在更高的地方“俯瞰”这些问题。</p><p>Java的Instrument给运行时的动态追踪留下了希望，Attach API则给运行时动态追踪提供了“出入口”，ASM则大大方便了“人类”操作Java字节码的操作。</p><p>基于Instrument和Attach API前辈们创造出了诸如JProfiler、Jvisualvm、BTrace这样的工具。以ASM为基础发展出了cglib、动态代理，继而是应用广泛的Spring AOP。</p><p>Java是静态语言，运行时不允许改变数据结构。然而，Java 5引入Instrument，Java 6引入Attach API之后，事情开始变得不一样了。虽然存在诸多限制，然而，在前辈们的努力下，仅仅是利用预留的近似于“只读”的这一点点狭小的空间，仍然创造出了各种大放异彩的技术，极大地提高了软件开发人员定位问题的效率。</p><p>计算机应该是人类有史以来最伟大的发明之一，从电磁感应磁生电，到高低电压模拟0和1的比特，再到二进制表示出几种基本类型，再到基本类型表示出无穷的对象，最后无穷的对象组合交互模拟现实生活乃至整个宇宙。</p><p>两千五百年前，《道德经》有言：“道生一，一生二，二生三，三生万物。”</p><p>两千五百年后，计算机的发展过程也大抵如此吧。</p></div><section class="meta" id="footer-meta"><hr><div class="new-meta-box"><div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-09-15T21:56:40+08:00"><a class="notlink"><i class="fas fa-clock" aria-hidden="true"></i><p>更新于 2019年9月15日</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="tags/架构/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>架构</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="tags/动态追踪/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>动态追踪</p></a></div><div class="new-meta-item share -mob-share-list"><div class="-mob-share-list share-body"><a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.baiyp.ren/JAVA动态追踪技术.html&title=JAVA动态追踪技术 | 晓风残月的博客&pics=/images/website/avatar.jpg&summary=" target="_blank"><img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png"> </a><a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.baiyp.ren/JAVA动态追踪技术.html&title=JAVA动态追踪技术 | 晓风残月的博客&pics=/images/website/avatar.jpg&summary=" target="_blank"><img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png"> </a><a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer" href="http://service.weibo.com/share/share.php?url=http://www.baiyp.ren/JAVA动态追踪技术.html&title=JAVA动态追踪技术 | 晓风残月的博客&pics=/images/website/avatar.jpg&summary=" target="_blank"><img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png"></a></div></div></div></section><div class="prev-next"><section class="prev"><span class="art-item-left"><h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6><h4><a href="MYBATIS源码解析-04反射模块02.html" rel="prev" title="MYBATIS源码解析-反射模块02">MYBATIS源码解析-反射模块02</a></h4><h6 class="tags"><a class="tag" href="tags/mybatis/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>mybatis</a> <a class="tag" href="tags/源码/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>源码</a> <a class="tag" href="tags/反射模块/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>反射模块</a></h6></span></section><section class="next"><span class="art-item-right" aria-hidden="true"><h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6><h4><a href="MYBATIS源码解析-04反射模块01.html" rel="prev" title="MYBATIS源码解析-反射模块01">MYBATIS源码解析-反射模块01</a></h4><h6 class="tags"><a class="tag" href="tags/mybatis/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>mybatis</a> <a class="tag" href="tags/源码/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>源码</a> <a class="tag" href="tags/反射模块/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>反射模块</a></h6></span></section></div></section></article><article class="post white-box comments"><section class="article typo"><h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;评论</h4><section id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80NTg2Ny8yMjM3OA"><noscript><div><i class="fas fa-exclamation-triangle">&nbsp;无法加载Livere评论系统，请确保您的网络能够正常访问。</i></div></noscript></div></section></section></article><script>window.subData={title:"JAVA动态追踪技术",tools:!0}</script></div><aside class="l_side"><section class="widget author"><div class="content pure"><div class="avatar"><img class="avatar" src="../../images/website/avatar.jpg"></div><div class="text"><p><span id="jinrishici-sentence">柳暗花明又一村</span></p><script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script></div><div class="social-wrapper"><a href="atom.xml" class="social fas fa-rss flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="mailto:baiyunpeng42@126.com" class="social fas fa-envelope flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://github.com/baiyunpeng" class="social fab fa-github flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://music.163.com/#/user/home?id=1973042285" class="social fas fa-headphones-alt flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a></div></div></section><section class="widget plain"><header class="pure"><div><i class="fa fa-book-open fa-fw fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;格言</div></header><div class="content pure"><p>日拱一卒无有尽,功不唐捐终入海</p></div></section><section class="widget toc-wrapper"><header class="pure"><div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div><div class="wrapper"><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div></header><div class="content pure"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA动态追踪技术"><span class="toc-text">JAVA动态追踪技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引子"><span class="toc-text">引子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从JSP说起"><span class="toc-text">从JSP说起</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java对象行为"><span class="toc-text">Java对象行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java-lang-instrument-Instrumentation"><span class="toc-text">java.lang.instrument.Instrumentation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接操作字节码"><span class="toc-text">直接操作字节码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BTrace"><span class="toc-text">BTrace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arthas"><span class="toc-text">Arthas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#尾声"><span class="toc-text">尾声</span></a></li></ol></li></ol></div></section><section class="widget plain"><header class="pure"><div><i class="fa fa-bullhorn fa-fw fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;公告</div></header><div class="content pure"><p>自己记录和梳理下架构的知识，从高并发开始。</p></div></section><section class="widget grid"><header class="pure"><div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div></header><div class="content pure"><ul class="grid navgation"><li><a class="flat-box" title="index.html" href="index.html" id="index.html"><i class="fas fa-clock fa-fw" aria-hidden="true"></i> 近期文章</a></li><li><a class="flat-box" title="archives/" href="archives/" rel="nofollow" id="archives"><i class="fas fa-archive fa-fw" aria-hidden="true"></i> 文章归档</a></li><li><a class="flat-box" title="categories/" href="categories/" id="categories"><i class="fas fa-grip-horizontal fa-fw" aria-hidden="true"></i> 文章分类</a></li><li><a class="flat-box" title="categories/" href="categories/" id="categories"><i class="fas fa-book fa-fw fa-fw" aria-hidden="true"></i> 专题文章</a></li><li><a class="flat-box" title="/friends.html" href="/friends.html" rel="nofollow" id="friends.html"><i class="fas fa-link fa-fw" aria-hidden="true"></i> 我的友链</a></li><li><a class="flat-box" title="/about.html" href="/about.html" rel="nofollow" id="about.html"><i class="fas fa-info-circle fa-fw" aria-hidden="true"></i> 关于小站</a></li></ul></div></section><section class="widget category"><header class="pure"><div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div><a class="rightBtn" rel="nofollow" href="categories/" title="categories/"><i class="fas fa-expand-arrows-alt fa-fw"></i></a></header><div class="content pure"><ul class="entry"><li><a class="flat-box" title="categories/jvm/" href="categories/jvm/"><div class="name">jvm</div><div class="badge">(8)</div></a></li><li><a class="flat-box child" title="categories/jvm/内存结构/" href="categories/jvm/内存结构/"><div class="name">内存结构</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/jvm/垃圾回收/" href="categories/jvm/垃圾回收/"><div class="name">垃圾回收</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="categories/jvm/对象分配/" href="categories/jvm/对象分配/"><div class="name">对象分配</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/jvm/指令/" href="categories/jvm/指令/"><div class="name">指令</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/jvm/运行时数据区/" href="categories/jvm/运行时数据区/"><div class="name">运行时数据区</div><div class="badge">(3)</div></a></li><li><a class="flat-box" title="categories/lambda/" href="categories/lambda/"><div class="name">lambda</div><div class="badge">(1)</div></a></li><li><a class="flat-box" title="categories/mybatis/" href="categories/mybatis/"><div class="name">mybatis</div><div class="badge">(10)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/" href="categories/mybatis/源码/"><div class="name">源码</div><div class="badge">(9)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/代理封装/" href="categories/mybatis/源码/代理封装/"><div class="name">代理封装</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/初始化流程/" href="categories/mybatis/源码/初始化流程/"><div class="name">初始化流程</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/反射模块/" href="categories/mybatis/源码/反射模块/"><div class="name">反射模块</div><div class="badge">(4)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/数据库连接池/" href="categories/mybatis/源码/数据库连接池/"><div class="name">数据库连接池</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/日志/" href="categories/mybatis/源码/日志/"><div class="name">日志</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/mybatis/源码/缓存模块/" href="categories/mybatis/源码/缓存模块/"><div class="name">缓存模块</div><div class="badge">(1)</div></a></li><li><a class="flat-box" title="categories/代码片段/" href="categories/代码片段/"><div class="name">代码片段</div><div class="badge">(2)</div></a></li><li><a class="flat-box" title="categories/加密/" href="categories/加密/"><div class="name">加密</div><div class="badge">(4)</div></a></li><li><a class="flat-box" title="categories/并发/" href="categories/并发/"><div class="name">并发</div><div class="badge">(27)</div></a></li><li><a class="flat-box child" title="categories/并发/ThreadLocal/" href="categories/并发/ThreadLocal/"><div class="name">ThreadLocal</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="categories/并发/final/" href="categories/并发/final/"><div class="name">final</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/synchronized/" href="categories/并发/synchronized/"><div class="name">synchronized</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="categories/并发/volatile/" href="categories/并发/volatile/"><div class="name">volatile</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/伪共享/" href="categories/并发/伪共享/"><div class="name">伪共享</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="categories/并发/多线程基础/" href="categories/并发/多线程基础/"><div class="name">多线程基础</div><div class="badge">(5)</div></a></li><li><a class="flat-box child" title="categories/并发/工具类/" href="categories/并发/工具类/"><div class="name">工具类</div><div class="badge">(6)</div></a></li><li><a class="flat-box child" title="categories/并发/并发安全/" href="categories/并发/并发安全/"><div class="name">并发安全</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/死锁/" href="categories/并发/死锁/"><div class="name">死锁</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/线程安全/" href="categories/并发/线程安全/"><div class="name">线程安全</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/面试题/" href="categories/并发/面试题/"><div class="name">面试题</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/高级/" href="categories/并发/高级/"><div class="name">高级</div><div class="badge">(4)</div></a></li><li><a class="flat-box child" title="categories/并发/高级/CAS/" href="categories/并发/高级/CAS/"><div class="name">CAS</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/高级/显示锁/" href="categories/并发/高级/显示锁/"><div class="name">显示锁</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/高级/读写锁/" href="categories/并发/高级/读写锁/"><div class="name">读写锁</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/并发/高级/队列锁/" href="categories/并发/高级/队列锁/"><div class="name">队列锁</div><div class="badge">(1)</div></a></li><li><a class="flat-box" title="categories/架构/" href="categories/架构/"><div class="name">架构</div><div class="badge">(13)</div></a></li><li><a class="flat-box child" title="categories/架构/apollo/" href="categories/架构/apollo/"><div class="name">apollo</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/架构/git/" href="categories/架构/git/"><div class="name">git</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/架构/分布式事务/" href="categories/架构/分布式事务/"><div class="name">分布式事务</div><div class="badge">(8)</div></a></li><li><a class="flat-box child" title="categories/架构/动态追踪/" href="categories/架构/动态追踪/"><div class="name">动态追踪</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/架构/布隆过滤器/" href="categories/架构/布隆过滤器/"><div class="name">布隆过滤器</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/架构/装逼/" href="categories/架构/装逼/"><div class="name">装逼</div><div class="badge">(1)</div></a></li><li><a class="flat-box" title="categories/流式计算/" href="categories/流式计算/"><div class="name">流式计算</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/流式计算/stream/" href="categories/流式计算/stream/"><div class="name">stream</div><div class="badge">(1)</div></a></li><li><a class="flat-box" title="categories/源码/" href="categories/源码/"><div class="name">源码</div><div class="badge">(11)</div></a></li><li><a class="flat-box child" title="categories/源码/HashMap/" href="categories/源码/HashMap/"><div class="name">HashMap</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/源码/ThreadLocal/" href="categories/源码/ThreadLocal/"><div class="name">ThreadLocal</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="categories/源码/动态代理/" href="categories/源码/动态代理/"><div class="name">动态代理</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/源码/并发/" href="categories/源码/并发/"><div class="name">并发</div><div class="badge">(3)</div></a></li><li><a class="flat-box child" title="categories/源码/并发/高级/" href="categories/源码/并发/高级/"><div class="name">高级</div><div class="badge">(3)</div></a></li><li><a class="flat-box child" title="categories/源码/并发/高级/AQS/" href="categories/源码/并发/高级/AQS/"><div class="name">AQS</div><div class="badge">(3)</div></a></li><li><a class="flat-box child" title="categories/源码/线程池/" href="categories/源码/线程池/"><div class="name">线程池</div><div class="badge">(3)</div></a></li><li><a class="flat-box child" title="categories/源码/阻塞队列/" href="categories/源码/阻塞队列/"><div class="name">阻塞队列</div><div class="badge">(1)</div></a></li><li><a class="flat-box" title="categories/设计模式/" href="categories/设计模式/"><div class="name">设计模式</div><div class="badge">(10)</div></a></li><li><a class="flat-box child" title="categories/设计模式/代理模式/" href="categories/设计模式/代理模式/"><div class="name">代理模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/单例模式/" href="categories/设计模式/单例模式/"><div class="name">单例模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/工厂模式/" href="categories/设计模式/工厂模式/"><div class="name">工厂模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/建造者模式/" href="categories/设计模式/建造者模式/"><div class="name">建造者模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/模板模式/" href="categories/设计模式/模板模式/"><div class="name">模板模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/装饰器模式/" href="categories/设计模式/装饰器模式/"><div class="name">装饰器模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/观察者模式/" href="categories/设计模式/观察者模式/"><div class="name">观察者模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/设计原则/" href="categories/设计模式/设计原则/"><div class="name">设计原则</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/责任链模式/" href="categories/设计模式/责任链模式/"><div class="name">责任链模式</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="categories/设计模式/适配器模式/" href="categories/设计模式/适配器模式/"><div class="name">适配器模式</div><div class="badge">(1)</div></a></li></ul></div></section><section class="widget tagcloud"><header class="pure"><div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div><a class="rightBtn" rel="nofollow" href="tags/" title="tags/"><i class="fas fa-expand-arrows-alt fa-fw"></i></a></header><div class="content pure"><a href="tags/2PC/" style="font-size:14px;color:#999">2PC</a> <a href="tags/3PC/" style="font-size:14px;color:#999">3PC</a> <a href="tags/AQS/" style="font-size:15.82px;color:#8d8d8d">AQS</a> <a href="tags/ArrayBlockingQueue/" style="font-size:14px;color:#999">ArrayBlockingQueue</a> <a href="tags/BloomFilter/" style="font-size:14px;color:#999">BloomFilter</a> <a href="tags/CAS/" style="font-size:14px;color:#999">CAS</a> <a href="tags/HashMap/" style="font-size:14px;color:#999">HashMap</a> <a href="tags/JsonValidator/" style="font-size:14px;color:#999">JsonValidator</a> <a href="tags/MQ/" style="font-size:14px;color:#999">MQ</a> <a href="tags/Saga/" style="font-size:14px;color:#999">Saga</a> <a href="tags/TCC/" style="font-size:14px;color:#999">TCC</a> <a href="tags/ThreadLocal/" style="font-size:16.73px;color:#868686">ThreadLocal</a> <a href="tags/ThreadPoolExecutor/" style="font-size:15.82px;color:#8d8d8d">ThreadPoolExecutor</a> <a href="tags/apollo/" style="font-size:14px;color:#999">apollo</a> <a href="tags/binding模块/" style="font-size:14px;color:#999">binding模块</a> <a href="tags/final/" style="font-size:14px;color:#999">final</a> <a href="tags/httpClient/" style="font-size:14px;color:#999">httpClient</a> <a href="tags/json/" style="font-size:14px;color:#999">json</a> <a href="tags/jvm/" style="font-size:20.36px;color:#6e6e6e">jvm</a> <a href="tags/lambda/" style="font-size:14px;color:#999">lambda</a> <a href="tags/mybatis/" style="font-size:21.27px;color:#686868">mybatis</a> <a href="tags/ssh-key/" style="font-size:14px;color:#999">ssh key</a> <a href="tags/stream/" style="font-size:14px;color:#999">stream</a> <a href="tags/synchronized/" style="font-size:14.91px;color:#939393">synchronized</a> <a href="tags/volatile/" style="font-size:14px;color:#999">volatile</a> <a href="tags/三阶段提交/" style="font-size:14px;color:#999">三阶段提交</a> <a href="tags/代理封装/" style="font-size:14px;color:#999">代理封装</a> <a href="tags/代理模式/" style="font-size:14px;color:#999">代理模式</a> <a href="tags/代码片段/" style="font-size:14.91px;color:#939393">代码片段</a> <a href="tags/伪共享/" style="font-size:14.91px;color:#939393">伪共享</a> <a href="tags/元空间/" style="font-size:14px;color:#999">元空间</a> <a href="tags/分布式事务/" style="font-size:20.36px;color:#6e6e6e">分布式事务</a> <a href="tags/初始化流程/" style="font-size:14px;color:#999">初始化流程</a> <a href="tags/加密/" style="font-size:16.73px;color:#868686">加密</a> <a href="tags/动态代理/" style="font-size:14px;color:#999">动态代理</a> <a href="tags/动态追踪/" style="font-size:14px;color:#999">动态追踪</a> <a href="tags/单例模式/" style="font-size:14px;color:#999">单例模式</a> <a href="tags/反射模块/" style="font-size:16.73px;color:#868686">反射模块</a> <a href="tags/垃圾回收/" style="font-size:14.91px;color:#939393">垃圾回收</a> <a href="tags/多线程基础/" style="font-size:17.64px;color:grey">多线程基础</a> <a href="tags/实现原理/" style="font-size:15.82px;color:#8d8d8d">实现原理</a> <a href="tags/对象分配/" style="font-size:14px;color:#999">对象分配</a> <a href="tags/工具类/" style="font-size:18.55px;color:#7a7a7a">工具类</a> <a href="tags/工厂模式/" style="font-size:14px;color:#999">工厂模式</a> <a href="tags/布隆过滤器/" style="font-size:14px;color:#999">布隆过滤器</a> <a href="tags/并发/" style="font-size:24px;color:#555">并发</a> <a href="tags/并发安全/" style="font-size:15.82px;color:#8d8d8d">并发安全</a> <a href="tags/建造者模式/" style="font-size:14px;color:#999">建造者模式</a> <a href="tags/总结/" style="font-size:14px;color:#999">总结</a> <a href="tags/指令/" style="font-size:14px;color:#999">指令</a> <a href="tags/数据库连接池/" style="font-size:14px;color:#999">数据库连接池</a> <a href="tags/整体介绍/" style="font-size:14px;color:#999">整体介绍</a> <a href="tags/日志/" style="font-size:14px;color:#999">日志</a> <a href="tags/显示锁/" style="font-size:14px;color:#999">显示锁</a> <a href="tags/本地消息表/" style="font-size:14px;color:#999">本地消息表</a> <a href="tags/架构/" style="font-size:22.18px;color:#616161">架构</a> <a href="tags/模板模式/" style="font-size:14px;color:#999">模板模式</a> <a href="tags/死锁/" style="font-size:14px;color:#999">死锁</a> <a href="tags/永久代/" style="font-size:14px;color:#999">永久代</a> <a href="tags/活锁/" style="font-size:14px;color:#999">活锁</a> <a href="tags/流式计算/" style="font-size:14px;color:#999">流式计算</a> <a href="tags/源码/" style="font-size:23.09px;color:#5b5b5b">源码</a> <a href="tags/热部署/" style="font-size:14px;color:#999">热部署</a> <a href="tags/线程安全/" style="font-size:14px;color:#999">线程安全</a> <a href="tags/线程池/" style="font-size:15.82px;color:#8d8d8d">线程池</a> <a href="tags/线程私有/" style="font-size:14.91px;color:#939393">线程私有</a> <a href="tags/缓存模块/" style="font-size:14px;color:#999">缓存模块</a> <a href="tags/装逼/" style="font-size:14px;color:#999">装逼</a> <a href="tags/装饰器模式/" style="font-size:14px;color:#999">装饰器模式</a> <a href="tags/观察者模式/" style="font-size:14px;color:#999">观察者模式</a> <a href="tags/设计原则/" style="font-size:14px;color:#999">设计原则</a> <a href="tags/设计模式/" style="font-size:21.27px;color:#686868">设计模式</a> <a href="tags/读写锁/" style="font-size:14px;color:#999">读写锁</a> <a href="tags/责任链模式/" style="font-size:14px;color:#999">责任链模式</a> <a href="tags/运行时数据区/" style="font-size:14.91px;color:#939393">运行时数据区</a> <a href="tags/适配器模式/" style="font-size:14px;color:#999">适配器模式</a> <a href="tags/锁优化/" style="font-size:14px;color:#999">锁优化</a> <a href="tags/队列锁/" style="font-size:14px;color:#999">队列锁</a> <a href="tags/阻塞队列/" style="font-size:14px;color:#999">阻塞队列</a> <a href="tags/面试题/" style="font-size:14px;color:#999">面试题</a> <a href="tags/高级/" style="font-size:19.45px;color:#747474">高级</a></div></section></aside><footer id="footer" class="clearfix"><div class="social-wrapper"><a href="atom.xml" class="social fas fa-rss flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="mailto:baiyunpeng42@126.com" class="social fas fa-envelope flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://github.com/baiyunpeng" class="social fab fa-github flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://music.163.com/#/user/home?id=1973042285" class="social fas fa-headphones-alt flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a></div><br><div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p></div><div>本站使用 <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename" rel="external nofollow noopener noreferrer">Material X</a> 作为主题 ， 总访问量为 <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次 。</div></footer><script>setLoadingBarProgress(80)</script><script>setLoadingBarProgress(60)</script></div><a class="s-top fas fa-arrow-up fa-fw" href="javascript:void(0)"></a></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script>var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo",ROOT="/";ROOT.endsWith("/")||(ROOT+="/")</script><script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script><script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script><script type="text/javascript">$(function(){const e=$(".reveal");if(0!==e.length){const l=ScrollReveal({distance:0});l.reveal(".reveal")}})</script><script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script><script type="text/javascript">$(function(){Waves.attach(".flat-btn",["waves-button"]),Waves.attach(".float-btn",["waves-button","waves-float"]),Waves.attach(".float-btn-light",["waves-button","waves-float","waves-light"]),Waves.attach(".flat-box",["waves-block"]),Waves.attach(".float-box",["waves-block","waves-float"]),Waves.attach(".waves-image"),Waves.init()})</script><script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script type="text/javascript">$(function(){$(".cover").backstretch(["https://img.vim-cn.com/29/91197b04c13f512f734a76d4ac422d89dbe229.jpg"],{duration:"6000",fade:"2500"})})</script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.9/js/app.js"></script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.9/js/search.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script>let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };</script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });</script><script>setLoadingBarProgress(100)</script></body></html><!-- rebuild by neat -->